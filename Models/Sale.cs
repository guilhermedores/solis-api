using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace SolisApi.Models;

/// <summary>
/// Sale Aggregate Root (DDD)
/// Manages sale items, payments, and cancellation
/// Ensures business rules and invariants
/// </summary>
[Table("sales")]
public class Sale : Entity
{
    [Required]
    [Column("order_number")]
    public int OrderNumber { get; set; }
    
    [Column("client_sale_id")]
    public Guid? ClientSaleId { get; set; } // UUID generated by POS for offline sync

    [Required]
    [Column("store_id")]
    public Guid StoreId { get; set; }

    [Column("pos_id")]
    public Guid? PosId { get; set; }

    [Column("operator_id")]
    public Guid? OperatorId { get; set; }

    [Required]
    [Column("sale_datetime")]
    public DateTime SaleDateTime { get; set; } = DateTime.UtcNow;

    [Required]
    [MaxLength(50)]
    [Column("status")]
    public string Status { get; private set; } = "pending"; // pending, completed, canceled, processing

    [Required]
    [Column("subtotal", TypeName = "numeric(12,2)")]
    public decimal Subtotal { get; private set; }

    [Required]
    [Column("discount_total", TypeName = "numeric(12,2)")]
    public decimal DiscountTotal { get; private set; }

    [Required]
    [Column("tax_total", TypeName = "numeric(12,2)")]
    public decimal TaxTotal { get; private set; }

    [Required]
    [Column("total", TypeName = "numeric(12,2)")]
    public decimal Total { get; private set; }

    [Required]
    [MaxLength(50)]
    [Column("payment_status")]
    public string PaymentStatus { get; private set; } = "unpaid"; // unpaid, partial, paid, refunded

    // Navigation properties (protected set para controle do aggregate)
    private readonly List<SaleItem> _items = new();
    public IReadOnlyCollection<SaleItem> Items => _items.AsReadOnly();

    private readonly List<SalePayment> _payments = new();
    public IReadOnlyCollection<SalePayment> Payments => _payments.AsReadOnly();

    public SaleCancellation? Cancellation { get; private set; }

    // Factory method
    public static Sale Create(
        Guid storeId,
        Guid? posId,
        Guid? operatorId,
        Guid? clientSaleId = null,
        DateTime? saleDateTime = null)
    {
        var sale = new Sale
        {
            Id = Guid.NewGuid(),
            StoreId = storeId,
            PosId = posId,
            OperatorId = operatorId,
            ClientSaleId = clientSaleId,
            SaleDateTime = saleDateTime ?? DateTime.UtcNow,
            Status = "pending",
            PaymentStatus = "unpaid",
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        return sale;
    }

    // Add item with taxes
    public void AddItem(SaleItem item)
    {
        if (Status == "canceled")
            throw new InvalidOperationException("Cannot add items to a canceled sale");

        if (Status == "completed")
            throw new InvalidOperationException("Cannot add items to a completed sale");

        item.SaleId = Id;
        _items.Add(item);
        RecalculateTotals();
    }

    // Add payment
    public void AddPayment(SalePayment payment)
    {
        if (Status == "canceled")
            throw new InvalidOperationException("Cannot add payments to a canceled sale");

        payment.SaleId = Id;
        _payments.Add(payment);
        UpdatePaymentStatus();
    }

    // Cancel sale
    public void Cancel(string reason, string source, string cancellationType, decimal? refundAmount = null)
    {
        if (Status == "canceled")
            throw new InvalidOperationException("Sale is already canceled");

        Status = "canceled";
        Cancellation = new SaleCancellation
        {
            Id = Guid.NewGuid(),
            SaleId = Id,
            Reason = reason,
            Source = source,
            CancellationType = cancellationType,
            RefundAmount = refundAmount,
            CanceledAt = DateTime.UtcNow,
            CreatedAt = DateTime.UtcNow
        };
        UpdatedAt = DateTime.UtcNow;
    }

    // Update status
    public void UpdateStatus(string newStatus)
    {
        if (Status == "canceled")
            throw new InvalidOperationException("Cannot change status of a canceled sale");

        var validStatuses = new[] { "pending", "completed", "canceled", "processing" };
        if (!validStatuses.Contains(newStatus))
            throw new ArgumentException($"Invalid status: {newStatus}");

        Status = newStatus;
        UpdatedAt = DateTime.UtcNow;

        // Auto-complete if fully paid
        if (PaymentStatus == "paid" && Status == "pending")
            Status = "completed";
    }

    // Recalculate all totals
    private void RecalculateTotals()
    {
        Subtotal = _items.Sum(i => i.Quantity * i.UnitPrice);
        DiscountTotal = _items.Sum(i => i.DiscountAmount);
        TaxTotal = _items.Sum(i => i.TaxAmount);
        Total = Subtotal - DiscountTotal + TaxTotal;
        UpdatedAt = DateTime.UtcNow;
    }



    // Update payment status based on payments
    private void UpdatePaymentStatus()
    {
        var totalPaid = _payments.Where(p => p.Status == "processed").Sum(p => p.Amount);
        
        if (totalPaid >= Total)
        {
            PaymentStatus = "paid";
            if (Status == "pending")
                Status = "completed";
        }
        else if (totalPaid > 0)
        {
            PaymentStatus = "partial";
        }
        else
        {
            PaymentStatus = "unpaid";
        }

        UpdatedAt = DateTime.UtcNow;
    }

    // For EF Core deserialization
    private Sale() { }
}
